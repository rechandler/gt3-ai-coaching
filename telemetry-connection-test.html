<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GT3 Telemetry Connection Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .status {
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
      }
      .connected {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
      }
      .disconnected {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
      }
      .message {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        margin: 5px 0;
        padding: 10px;
      }
      .telemetry-data {
        background-color: #e2e3e5;
        border: 1px solid #ced4da;
        margin: 5px 0;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <h1>GT3 AI Coaching - Connection Test</h1>

    <div id="connectionStatus" class="status disconnected">
      Disconnected from telemetry server
    </div>

    <div id="coachingStatus" class="status disconnected">
      Disconnected from coaching server
    </div>

    <h2>Recent Messages</h2>
    <div id="messages"></div>

    <h2>Latest Telemetry Data</h2>
    <div id="telemetryData"></div>

    <script>
      // Test connection to telemetry/coaching service
      const ws = new WebSocket("ws://localhost:8082");
      const messages = [];
      let latestTelemetry = null;

      function updateStatus(elementId, connected, text) {
        const element = document.getElementById(elementId);
        element.className = connected
          ? "status connected"
          : "status disconnected";
        element.textContent = text;
      }

      function addMessage(message) {
        messages.unshift(message);
        if (messages.length > 10) messages.pop();

        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = messages
          .map(
            (msg) =>
              `<div class="message">
                    <strong>${new Date(
                      msg.timestamp
                    ).toLocaleTimeString()}</strong> - 
                    ${msg.type}: ${JSON.stringify(msg.data, null, 2)}
                </div>`
          )
          .join("");
      }

      function updateTelemetryDisplay() {
        const telemetryDiv = document.getElementById("telemetryData");
        if (latestTelemetry) {
          telemetryDiv.innerHTML = `<div class="telemetry-data">
                    <pre>${JSON.stringify(latestTelemetry, null, 2)}</pre>
                </div>`;
        }
      }

      ws.onopen = function () {
        updateStatus(
          "connectionStatus",
          true,
          "Connected to telemetry server (port 8082)"
        );
        updateStatus(
          "coachingStatus",
          true,
          "Connected to coaching server (port 8082)"
        );
      };

      ws.onmessage = function (event) {
        try {
          const message = JSON.parse(event.data);
          console.log("Received message:", message);

          addMessage({
            type: message.type,
            data: message.data || message,
            timestamp: Date.now(),
          });

          if (message.type === "telemetry" && message.data) {
            latestTelemetry = message.data;
            updateTelemetryDisplay();
          }
        } catch (error) {
          console.error("Error parsing message:", error);
        }
      };

      ws.onclose = function () {
        updateStatus(
          "connectionStatus",
          false,
          "Disconnected from telemetry server"
        );
        updateStatus(
          "coachingStatus",
          false,
          "Disconnected from coaching server"
        );
      };

      ws.onerror = function (error) {
        console.error("WebSocket error:", error);
        updateStatus("connectionStatus", false, "Connection error");
        updateStatus("coachingStatus", false, "Connection error");
      };
    </script>
  </body>
</html>
